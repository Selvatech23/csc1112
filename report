Private Sub cmdReport_Click()
    ' --- FINAL DIAGNOSTIC: Visible Excel and Simple Path ---
    
    Dim conn As Object, rs As Object, dbPath As String
    Dim xlApp As Object, xlBook As Object, xlSheet1 As Object
    Dim fileName As String
    
    On Error GoTo GenericErrHandler
    
    ' --- 1. SETUP ---
    dbPath = "F:\selva\CDD-NWM\Macro\CompanyData.accdb"
    fileName = "C:\Temp\CompanyReport_Test.xlsx" 'Saving to a simple, trusted path
    
    ' --- Check if C:\Temp exists ---
    If Dir("C:\Temp", vbDirectory) = "" Then
        MsgBox "Error: The folder C:\Temp was not found. Please create it manually and try again.", vbCritical
        Exit Sub
    End If
    
    MsgBox "This test will now try to save a file to: " & fileName
    
    ' --- 2. FETCH DATA ---
    Set conn = CreateObject("ADODB.Connection")
    conn.Open "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & dbPath
    Set rs = conn.Execute("SELECT * FROM CompanyRecords")
    
    If rs.EOF Then
        MsgBox "No data in the database to report on.", vbInformation
        rs.Close: conn.Close
        Exit Sub
    End If
    
    ' --- 3. CREATE VISIBLE EXCEL WORKBOOK ---
    Set xlApp = ThisWorkbook.Application
    Set xlBook = xlApp.Workbooks.Add ' You will see a new workbook appear
    xlApp.Visible = True ' Ensure Excel is visible
    Set xlSheet1 = xlBook.Sheets(1)
    
    ' --- 4. POPULATE DATA ---
    Dim i As Long
    For i = 0 To rs.Fields.Count - 1
        xlSheet1.Cells(1, i + 1).Value = rs.Fields(i).Name
    Next i
    xlSheet1.Cells(2, 1).CopyFromRecordset rs
    rs.Close: conn.Close
    xlSheet1.Columns.AutoFit
    
    ' --- 5. ATTEMPT TO SAVE ---
    On Error Resume Next
    Kill fileName
    On Error GoTo GenericErrHandler
    
    MsgBox "Data is populated. The code will now attempt to save the visible workbook.", vbInformation
    
    xlBook.SaveAs fileName, 51 ' Attempting to save the new, VISIBLE workbook
    
    MsgBox "The 'SaveAs' command has been executed.", vbInformation
    
    ' --- 6. FINAL VERIFICATION ---
    If Dir(fileName) = "" Then
        MsgBox "CRITICAL FAILURE: The SaveAs command ran but the file was NOT created." & vbCrLf & _
               "This confirms an external program (Antivirus/Security) is blocking the save." & vbCrLf & _
               "Please show this message to your IT department.", vbCritical
    Else
        MsgBox "SUCCESS! The test file was created successfully at: " & fileName, vbInformation
        xlBook.Close False ' Close the test book
    End If

    Exit Sub ' End of the process

GenericErrHandler:
    MsgBox "An error occurred." & vbCrLf & "Number: " & Err.Number & vbCrLf & "Description: " & Err.Description, vbCritical
End Sub
